<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Description Collector</title>
    <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
        .header {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 100;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .floor-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .room-selector-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .room-selector-group label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }

        .room-select {
            padding: 5px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            background: white;
            cursor: pointer;
            min-width: 100px;
            transition: border-color 0.2s;
        }

        .room-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .room-select.start { border-color: #28a745; }
        .room-select.end { border-color: #dc3545; }

        .calc-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 6px 18px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .calc-btn:hover { background: #2d3748; }
        .calc-btn:disabled { background: #ccc; cursor: not-allowed; }

        .route-info {
            font-size: 12px;
            color: #888;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .route-info strong { color: #667eea; }

        /* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            gap: 12px;
            padding: 12px;
        }

        /* ‚îÄ‚îÄ‚îÄ MAP PANEL ‚îÄ‚îÄ‚îÄ */
        .map-panel {
            flex: 1 1 58%;
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            overflow: hidden;
            min-width: 0;
        }

        .svg-container {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        .svg-container:active { cursor: grabbing; }

        .svg-container svg {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(8px);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
            pointer-events: none;
        }

        .map-overlay strong { color: #667eea; }

        .floor-nav {
            position: absolute;
            top: 12px;
            right: 70px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(8px);
            padding: 6px 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            z-index: 10;
        }

        .floor-nav-btn {
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .floor-nav-btn:hover:not(:disabled) { background: #5a6fd6; }
        .floor-nav-btn:disabled { background: #ccc; cursor: not-allowed; }

        .floor-nav-label {
            font-size: 13px;
            font-weight: 700;
            color: #333;
            min-width: 50px;
            text-align: center;
        }

        .zoom-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 10;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .zoom-btn:hover { background: #667eea; color: white; }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }

        .loading-overlay.active { display: flex; }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ‚îÄ STEPS PANEL ‚îÄ‚îÄ‚îÄ */
        .steps-panel {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .steps-header {
            padding: 14px 18px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .steps-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .steps-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
        }

        .steps-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }

        .progress-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .steps-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            scrollbar-gutter: stable;
        }

        .steps-list::-webkit-scrollbar { width: 6px; }
        .steps-list::-webkit-scrollbar-track { background: transparent; }
        .steps-list::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }

        .step-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .step-card.filled { border-color: #28a745; background: #f8fff9; }

        .step-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
            background: #667eea;
        }

        .step-number.start { background: #667eea; }
        .step-number.turn, .step-number.turn_left, .step-number.turn_right { background: #e74c3c; }
        .step-number.veer { background: #f39c12; }
        .step-number.pass_by { background: #3498db; }
        .step-number.arrive { background: #27ae60; }
        .step-number.floor_change { background: #9b59b6; }

        .step-action {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
        }

        .step-action.start { background: #667eea; }
        .step-action.turn, .step-action.turn_left, .step-action.turn_right { background: #e74c3c; }
        .step-action.veer { background: #f39c12; }
        .step-action.pass_by { background: #3498db; }
        .step-action.arrive { background: #27ae60; }
        .step-action.floor_change { background: #9b59b6; }

        .step-landmark {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }
        .step-alt-anchors {
            font-size: 11px;
            color: #888;
            padding: 2px 0 2px 44px;
            font-style: italic;
        }

        .step-distance {
            font-size: 12px;
            color: #888;
            margin-left: auto;
        }

        .step-system-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #999;
            margin-bottom: 2px;
        }

        .step-system-desc {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            color: #555;
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .step-input-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #667eea;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .step-textarea {
            width: 100%;
            min-height: 60px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .step-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .step-textarea.has-text { border-color: #28a745; }
        .step-textarea::placeholder { color: #bbb; font-size: 13px; }

        /* ‚îÄ‚îÄ‚îÄ STEP ACTION BUTTONS ‚îÄ‚îÄ‚îÄ */
        .step-action-btns {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }

        .step-action-btns button {
            padding: 5px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }

        .step-action-btns button:hover { background: #f5f5f5; }

        .step-action-btns .btn-keep {
            color: #28a745;
            border-color: #28a745;
        }

        .step-action-btns .btn-keep.active {
            background: #28a745;
            color: white;
        }

        .step-action-btns .btn-delete {
            color: #dc3545;
            border-color: #dc3545;
        }

        .step-action-btns .btn-delete.active {
            background: #dc3545;
            color: white;
        }

        /* ‚îÄ‚îÄ‚îÄ USER NAME INPUT ‚îÄ‚îÄ‚îÄ */
        .user-name-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-name-group label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }

        .user-name-input {
            padding: 8px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            background: white;
            width: 200px;
            transition: border-color 0.2s;
        }

        .user-name-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .user-name-input.saved { border-color: #28a745; }

        /* ‚îÄ‚îÄ‚îÄ DUPLICATE CHIP ‚îÄ‚îÄ‚îÄ */
        .duplicate-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .duplicate-chip.exists {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .duplicate-chip.new-route {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        /* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
        .steps-footer {
            padding: 14px 20px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            gap: 10px;
        }

        .steps-counter { font-size: 13px; color: #888; font-weight: 500; }
        .steps-counter strong { color: #667eea; }

        .submit-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #aaa;
            font-size: 14px;
            text-align: center;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            transition: transform 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }

        /* ‚îÄ‚îÄ‚îÄ TAB SWITCHER (mobile only) ‚îÄ‚îÄ‚îÄ */
        .tab-switcher {
            display: none;
        }

        .tab-switcher button {
            flex: 1;
            padding: 10px 0;
            border: none;
            background: #f0f2f5;
            font-size: 14px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tab-switcher button.active {
            color: #667eea;
            background: white;
        }

        .tab-switcher button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 3px 3px 0 0;
        }

        /* ‚îÄ‚îÄ‚îÄ MOBILE RESPONSIVE ‚îÄ‚îÄ‚îÄ */
        @media (max-width: 768px) {
            body {
                height: auto;
                overflow: auto;
            }

            .app-container {
                height: auto;
                min-height: 100vh;
            }

            /* Header: vertical stack */
            .header {
                flex-direction: column;
                align-items: stretch;
                padding: 12px 14px;
                gap: 8px;
            }

            .title {
                font-size: 16px;
                justify-content: center;
            }

            .room-selector-group {
                display: grid;
                grid-template-columns: auto 1fr 2fr;
                gap: 6px;
                align-items: center;
            }

            .room-selector-group label {
                font-size: 13px;
                min-width: 70px;
            }

            .room-select {
                width: 100%;
                font-size: 14px;
                padding: 8px 10px;
            }

            .calc-btn {
                width: 100%;
                padding: 12px;
                font-size: 15px;
                border-radius: 10px;
            }

            .route-info {
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
                font-size: 13px;
            }

            /* Tab switcher visible on mobile */
            .tab-switcher {
                display: flex;
                border-bottom: 1px solid #e0e0e0;
                flex-shrink: 0;
            }

            /* Main content: vertical stack with tabs */
            .main-content {
                flex-direction: column;
                gap: 0;
                padding: 0;
                flex: 1;
            }

            .map-panel {
                border-radius: 0;
                box-shadow: none;
                min-height: 50vh;
                height: 50vh;
                flex: none;
            }

            .map-panel.hidden-tab {
                display: none !important;
            }

            .steps-panel {
                border-radius: 0;
                box-shadow: none;
                flex: none;
                display: none; /* hidden by default on mobile (map tab first) */
            }

            .steps-panel.hidden-tab {
                display: none !important;
            }

            /* Full screen for active tab */
            .map-panel.active-tab {
                display: block;
                flex: 1;
                height: auto;
                min-height: calc(100vh - 200px);
            }

            .steps-panel.active-tab {
                display: flex;
                flex: 1;
                height: auto;
                min-height: calc(100vh - 200px);
            }

            .steps-list {
                max-height: none;
                overflow-y: visible;
            }

            /* Zoom controls */
            .zoom-controls {
                bottom: 12px;
                right: 12px;
            }

            .zoom-btn {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            /* Floor nav */
            .floor-nav {
                right: auto;
                left: 50%;
                transform: translateX(-50%);
                top: 10px;
            }

            .floor-nav-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .steps-header-top {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .user-name-input {
                width: 100%;
                font-size: 14px;
                padding: 8px 10px;
            }

            /* Step cards */
            .step-card {
                padding: 12px;
                margin-bottom: 10px;
            }

            .step-textarea {
                font-size: 16px; /* prevents iOS zoom on focus */
                min-height: 50px;
            }

            .step-system-desc {
                font-size: 11px;
                padding: 6px 8px;
            }

            /* Submit footer */
            .steps-footer {
                padding: 12px 14px;
                position: sticky;
                bottom: 0;
                background: white;
                z-index: 50;
            }

            .submit-btn {
                padding: 14px;
                font-size: 16px;
            }

            /* Toast */
            .toast {
                bottom: 80px;
                font-size: 13px;
                padding: 12px 20px;
            }

            /* Map overlay */
            .map-overlay {
                top: 8px;
                left: 8px;
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        /* Small phones */
        @media (max-width: 380px) {
            .room-selector-group {
                grid-template-columns: 1fr 1fr;
                gap: 4px;
            }

            .room-selector-group label {
                grid-column: 1 / -1;
            }

            .title {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="title">
                Route Description Collector
            </div>

            <div class="room-selector-group">
                <label>Start:</label>
                <select class="room-select" id="startFloorSelect" onchange="onStartFloorChange()"></select>
                <select class="room-select start" id="startSelect"></select>
            </div>

            <div class="room-selector-group">
                <label>Destination:</label>
                <select class="room-select" id="endFloorSelect" onchange="onEndFloorChange()"></select>
                <select class="room-select end" id="endSelect"></select>
            </div>

            <button class="calc-btn" id="calcBtn" onclick="calculateRoute()">
                Calculate
            </button>

            <div class="route-info" id="routeInfo" style="display: none;">
                <span>Distance: <strong id="distInfo">-</strong></span>
                <span>Turns: <strong id="turnInfo">-</strong></span>
                <span id="floorChangeInfo" style="display: none;"></span>
                <span id="duplicateChip"></span>
            </div>
        </div>

        <!-- TAB SWITCHER (mobile only) -->
        <div class="tab-switcher" id="tabSwitcher">
            <button class="active" id="tabMap" onclick="switchTab('map')">üó∫Ô∏è Map</button>
            <button id="tabSteps" onclick="switchTab('steps')">üìù Steps</button>
        </div>

        <!-- MAIN -->
        <div class="main-content">
            <!-- MAP -->
            <div class="map-panel active-tab" id="mapPanel">
                <div class="map-overlay" id="mapOverlay">
                    Zoom: <strong id="zoomLevel">100%</strong>
                </div>

                <div class="floor-nav" id="floorNav" style="display: none;">
                    <button class="floor-nav-btn" id="prevFloorBtn" onclick="prevFloorSvg()" disabled>‚óÄ</button>
                    <span class="floor-nav-label" id="floorNavLabel">Kat 0</span>
                    <button class="floor-nav-btn" id="nextFloorBtn" onclick="nextFloorSvg()">‚ñ∂</button>
                </div>

                <div class="svg-container" id="svgContainer"></div>

                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="pzZoomIn()">+</button>
                    <button class="zoom-btn" onclick="pzZoomOut()">‚àí</button>
                    <button class="zoom-btn" onclick="pzReset()" title="Reset">‚ü≤</button>
                </div>

                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                    Calculating route...
                </div>
            </div>

            <!-- STEPS -->
            <div class="steps-panel" id="stepsPanel">
                <div class="steps-header">
                    <div class="steps-header-top">
                        <div>
                            <div class="steps-title">Step Descriptions</div>
                            <div class="steps-subtitle">Enter your name and describe each step</div>
                        </div>
                        <div class="user-name-group">
                            <input type="text" class="user-name-input" id="userNameInput"
                                   placeholder="Your name..."
                                   oninput="onUserNameChange(this)">
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="steps-list" id="stepsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        Steps will appear here<br>when a route is calculated
                    </div>
                </div>

                <div class="steps-footer">
                    <div class="steps-counter">
                        <strong id="filledCount">0</strong> / <span id="totalCount">0</span> completed
                    </div>
                    <button class="submit-btn" id="submitBtn" disabled onclick="submitDescriptions()">
                        Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
        let allRooms = {};
        let currentSteps = [];
        let userDescriptions = {};
        let pzInstance = null;
        let currentRoute = { start: '', end: '', floor: '', start_floor: '', end_floor: '' };
        let floorSvgs = [];
        let currentFloorIdx = 0;
        let submittedRoutes = new Set();

        // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
        async function init() {
            try {
                // Load user name from localStorage
                const savedName = localStorage.getItem('collector_user_name') || '';
                const nameInput = document.getElementById('userNameInput');
                nameInput.value = savedName;
                if (savedName) nameInput.classList.add('saved');

                const [roomsResp, routesResp] = await Promise.all([
                    fetch('/api/rooms'),
                    fetch('/api/submitted-routes'),
                ]);
                allRooms = await roomsResp.json();

                try {
                    const routes = await routesResp.json();
                    submittedRoutes = new Set(routes);
                } catch (e) {
                    console.warn('Could not load submitted routes:', e);
                }

                populateFloorSelects();
                onStartFloorChange();
                onEndFloorChange();
            } catch (e) {
                console.error('Failed to load rooms:', e);
            }
        }

        function onUserNameChange(el) {
            const name = el.value.trim();
            localStorage.setItem('collector_user_name', name);
            if (name) {
                el.classList.add('saved');
            } else {
                el.classList.remove('saved');
            }
            updateProgress();
        }

        function populateFloorSelects() {
            const floors = Object.keys(allRooms);
            ['startFloorSelect', 'endFloorSelect'].forEach(id => {
                const sel = document.getElementById(id);
                sel.innerHTML = '';
                for (const floor of floors) {
                    const opt = document.createElement('option');
                    opt.value = floor;
                    opt.textContent = floor;
                    sel.appendChild(opt);
                }
            });
        }

        function clearRouteDisplay() {
            // Clear steps
            currentSteps = [];
            userDescriptions = {};
            const stepsEl = document.getElementById('stepsList');
            stepsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div>Steps will appear here<br>when a route is calculated</div>';
            // Reset progress
            document.getElementById('filledCount').textContent = '0';
            document.getElementById('totalCount').textContent = '0';
            document.getElementById('progressFill').style.width = '0%';
            // Hide floor nav
            const floorNav = document.getElementById('floorNav');
            if (floorNav) floorNav.style.display = 'none';
            floorSvgs = [];
            currentFloorIdx = 0;
            // Reset route info
            currentRoute = { start: '', end: '', floor: '', start_floor: '', end_floor: '' };
        }

        async function onStartFloorChange() {
            const floor = document.getElementById('startFloorSelect').value;
            const rooms = allRooms[floor] || [];
            populateRoomSelect('startSelect', rooms);

            // Clear existing route display when floor changes
            clearRouteDisplay();

            // Show the selected floor's SVG on the map
            await loadFloorSvg(floor);
        }

        async function onEndFloorChange() {
            const floor = document.getElementById('endFloorSelect').value;
            const rooms = allRooms[floor] || [];
            populateRoomSelect('endSelect', rooms);

            // Clear existing route display when floor changes
            clearRouteDisplay();

            // Show the selected floor's SVG on the map
            await loadFloorSvg(floor);
        }

        async function loadFloorSvg(floorName) {
            const container = document.getElementById('svgContainer');
            try {
                const resp = await fetch(`/api/floor-svg/${encodeURIComponent(floorName)}`);
                if (!resp.ok) throw new Error('Failed to load SVG');
                const svgContent = await resp.text();
                updateMap(svgContent);
            } catch (e) {
                console.error('Failed to load floor SVG:', e);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üó∫Ô∏è</div>Failed to load map</div>';
            }
        }

        function populateRoomSelect(selectId, rooms) {
            const sel = document.getElementById(selectId);
            sel.innerHTML = '<option value="">-- Select --</option>';
            for (const room of rooms) {
                const opt = document.createElement('option');
                opt.value = room.id;
                opt.textContent = room.label;
                sel.appendChild(opt);
            }
        }

        // ‚îÄ‚îÄ‚îÄ ROUTE CALCULATION ‚îÄ‚îÄ‚îÄ
        async function calculateRoute() {
            const startFloor = document.getElementById('startFloorSelect').value;
            const endFloor = document.getElementById('endFloorSelect').value;
            const startId = document.getElementById('startSelect').value;
            const endId = document.getElementById('endSelect').value;

            if (!startId || !endId) {
                showToast('Please select start and destination', 'error');
                return;
            }

            if (startId === endId && startFloor === endFloor) {
                showToast('Start and destination must be different', 'error');
                return;
            }

            // Loading
            const btn = document.getElementById('calcBtn');
            btn.disabled = true;
            btn.textContent = '...';
            document.getElementById('loadingOverlay').classList.add('active');

            try {
                const resp = await fetch('/api/route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_floor: startFloor,
                        start_id: startId,
                        end_floor: endFloor,
                        end_id: endId
                    })
                });

                const data = await resp.json();

                if (!resp.ok) {
                    showToast(data.error || 'Route calculation failed', 'error');
                    return;
                }

                // Update map
                updateMap(data.svg);

                // Update steps
                currentSteps = data.steps;
                currentRoute = {
                    start: data.start,
                    end: data.end,
                    floor: data.floor,
                    start_floor: data.start_floor || data.floor,
                    end_floor: data.end_floor || data.floor
                };
                userDescriptions = {};
                renderSteps();

                // Multi-floor: floor SVG navigation
                const floorNav = document.getElementById('floorNav');
                if (data.is_multi_floor && data.floor_svgs && data.floor_svgs.length > 1) {
                    floorSvgs = data.floor_svgs;
                    currentFloorIdx = 0;
                    floorNav.style.display = 'flex';
                    updateFloorNav();
                } else {
                    floorSvgs = [];
                    currentFloorIdx = 0;
                    floorNav.style.display = 'none';
                }

                // Update info
                document.getElementById('routeInfo').style.display = 'flex';
                document.getElementById('distInfo').textContent = data.distance.toFixed(1) + 'm';
                document.getElementById('turnInfo').textContent = data.turns;
                
                // Multi-floor info
                const floorChangeEl = document.getElementById('floorChangeInfo');
                if (data.is_multi_floor && data.floor_changes > 0) {
                    floorChangeEl.style.display = 'inline';
                    floorChangeEl.innerHTML = 'Floor Changes: <strong>' + data.floor_changes + '</strong>';
                } else {
                    floorChangeEl.style.display = 'none';
                }

                // Duplicate check
                updateDuplicateChip();

                showToast('Route calculated', 'success');

                // Mobile: auto-switch to steps tab
                autoSwitchToStepsIfMobile();

            } catch (e) {
                console.error(e);
                showToast('Server error', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Calculate';
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        // ‚îÄ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ
        function updateMap(svgContent) {
            const container = document.getElementById('svgContainer');

            // Destroy old panzoom
            if (pzInstance) {
                pzInstance.dispose();
                pzInstance = null;
            }

            // Set SVG content
            container.innerHTML = svgContent;

            // Find the SVG element
            const svgEl = container.querySelector('svg');
            if (!svgEl) return;

            // Init panzoom on the SVG element
            pzInstance = panzoom(svgEl, {
                maxZoom: 10,
                minZoom: 0.1,
                smoothScroll: false,
                zoomDoubleClickSpeed: 1,
                beforeWheel: function(e) {
                    return false; // allow wheel zoom always
                },
                beforeMouseDown: function(e) {
                    return false; // allow pan always
                }
            });

            // Update zoom level display
            pzInstance.on('zoom', function(e) {
                const t = e.getTransform();
                document.getElementById('zoomLevel').textContent = Math.round(t.scale * 100) + '%';
            });
        }

        function pzZoomIn() {
            if (pzInstance) {
                const t = pzInstance.getTransform();
                const container = document.getElementById('svgContainer');
                const rect = container.getBoundingClientRect();
                pzInstance.smoothZoom(rect.width / 2, rect.height / 2, 1.3);
            }
        }

        function pzZoomOut() {
            if (pzInstance) {
                const t = pzInstance.getTransform();
                const container = document.getElementById('svgContainer');
                const rect = container.getBoundingClientRect();
                pzInstance.smoothZoom(rect.width / 2, rect.height / 2, 0.7);
            }
        }

        function pzReset() {
            if (pzInstance) {
                pzInstance.moveTo(0, 0);
                pzInstance.zoomAbs(0, 0, 1);
                document.getElementById('zoomLevel').textContent = '100%';
            }
        }

        // ‚îÄ‚îÄ‚îÄ FLOOR NAV (multi-floor) ‚îÄ‚îÄ‚îÄ
        function updateFloorNav() {
            document.getElementById('floorNavLabel').textContent = floorSvgs[currentFloorIdx].floor;
            document.getElementById('prevFloorBtn').disabled = (currentFloorIdx === 0);
            document.getElementById('nextFloorBtn').disabled = (currentFloorIdx >= floorSvgs.length - 1);
        }

        function prevFloorSvg() {
            if (currentFloorIdx > 0) {
                currentFloorIdx--;
                updateMap(floorSvgs[currentFloorIdx].svg);
                updateFloorNav();
            }
        }

        function nextFloorSvg() {
            if (currentFloorIdx < floorSvgs.length - 1) {
                currentFloorIdx++;
                updateMap(floorSvgs[currentFloorIdx].svg);
                updateFloorNav();
            }
        }

        // ‚îÄ‚îÄ‚îÄ STEPS RENDERING ‚îÄ‚îÄ‚îÄ
        function getActionClass(action) {
            const a = action.toLowerCase();
            if (a === 'start') return 'start';
            if (a.includes('turn')) return a.replace(' ', '_');
            if (a === 'veer') return 'veer';
            if (a === 'pass_by') return 'pass_by';
            if (a === 'arrive') return 'arrive';
            if (a === 'floor_change') return 'floor_change';
            return 'start';
        }

        function getActionLabel(action) {
            const labels = {
                'START': 'START',
                'TURN_LEFT': 'TURN LEFT',
                'TURN_RIGHT': 'TURN RIGHT',
                'VEER': 'VEER',
                'PASS_BY': 'PASS BY',
                'ARRIVE': 'ARRIVE',
                'FLOOR_CHANGE': 'FLOOR'
            };
            return labels[action] || action;
        }

        function renderSteps() {
            const stepsEl = document.getElementById('stepsList');

            if (currentSteps.length === 0) {
                stepsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div>Steps will appear here<br>when a route is calculated</div>';
                return;
            }

            let html = '';
            currentSteps.forEach((step) => {
                const actionClass = getActionClass(step.action);
                const savedText = userDescriptions[step.step_number] || '';
                const filledClass = savedText.trim() ? ' filled' : '';
                const textClass = savedText.trim() ? ' has-text' : '';

                const distVal = step.distance_meters != null ? step.distance_meters : 0;
                const distStr = distVal.toFixed(1) + 'm';
                const landmark = step.landmark || '';
                const landmarkBracket = landmark ? `[${landmark}]` : '';

                const actionPad = step.action.padEnd(12);
                const distPad = distStr.padStart(5);
                const landmarkPad = landmarkBracket.padEnd(20);
                const fullSystemLine = `${step.step_number}. ${actionPad} ${distPad} ${landmarkPad} | ${step.description}`;

                // Alternative anchors line
                const altLandmarks = step.alt_landmarks || [];
                let altLine = '';
                if (altLandmarks.length > 0) {
                    altLine = `\n   Alt: ${altLandmarks.join(' | ')}`;
                }

                const isKeep = savedText === '+';
                const isDelete = savedText === '-';
                const hasCustom = savedText && !isKeep && !isDelete;

                html += `
                <div class="step-card${filledClass}" id="card-${step.step_number}">
                    <div class="step-card-header">
                        <div class="step-number ${actionClass}">${step.step_number}</div>
                        <span class="step-action ${actionClass}">${getActionLabel(step.action)}</span>
                        ${landmark ? `<span class="step-landmark">${landmark}</span>` : ''}
                        ${distStr !== '0.0m' ? `<span class="step-distance">${distStr}</span>` : ''}
                    </div>
                    ${altLandmarks.length > 0 ? `<div class="step-alt-anchors">Alt: ${altLandmarks.join(' ¬∑ ')}</div>` : ''}
                    <div class="step-system-label">System</div>
                    <div class="step-system-desc">${fullSystemLine}${altLine}</div>
                    <div class="step-input-label">Your Description</div>
                    <div class="step-action-btns">
                        <button class="btn-keep${isKeep ? ' active' : ''}"
                                onclick="setStepAction(${step.step_number}, '+')">Keep as is</button>
                        <button class="btn-delete${isDelete ? ' active' : ''}"
                                onclick="setStepAction(${step.step_number}, '-')">Remove this step</button>
                    </div>
                    <textarea 
                        class="step-textarea${textClass}" 
                        id="input-${step.step_number}" 
                        data-step="${step.step_number}"
                        placeholder="Custom description or use buttons above..."
                        oninput="onStepInput(this)"
                    >${hasCustom ? savedText : ''}</textarea>
                </div>`;
            });

            stepsEl.innerHTML = html;
            document.getElementById('totalCount').textContent = currentSteps.length;
            updateProgress();
        }

        function setStepAction(stepNum, action) {
            const current = userDescriptions[stepNum];
            if (current === action) {
                userDescriptions[stepNum] = '';
            } else {
                userDescriptions[stepNum] = action;
            }

            const textarea = document.getElementById('input-' + stepNum);
            if (textarea) {
                if (userDescriptions[stepNum] === '+' || userDescriptions[stepNum] === '-') {
                    textarea.value = '';
                }
            }

            const card = document.getElementById('card-' + stepNum);
            const keepBtn = card.querySelector('.btn-keep');
            const delBtn = card.querySelector('.btn-delete');

            keepBtn.classList.toggle('active', userDescriptions[stepNum] === '+');
            delBtn.classList.toggle('active', userDescriptions[stepNum] === '-');

            if (userDescriptions[stepNum]) {
                card.classList.add('filled');
            } else {
                card.classList.remove('filled');
            }
            updateProgress();
        }

        function onStepInput(el) {
            const stepNum = parseInt(el.dataset.step);
            const text = el.value.trim();

            if (text) {
                userDescriptions[stepNum] = el.value;
                const card = document.getElementById('card-' + stepNum);
                const keepBtn = card.querySelector('.btn-keep');
                const delBtn = card.querySelector('.btn-delete');
                keepBtn.classList.remove('active');
                delBtn.classList.remove('active');
            } else {
                userDescriptions[stepNum] = '';
            }

            const card = document.getElementById('card-' + stepNum);
            if (text) {
                el.classList.add('has-text');
                card.classList.add('filled');
            } else {
                el.classList.remove('has-text');
                card.classList.remove('filled');
            }
            updateProgress();
        }

        function updateProgress() {
            let filled = 0;
            currentSteps.forEach(step => {
                const val = (userDescriptions[step.step_number] || '').trim();
                if (val) filled++;
            });

            document.getElementById('filledCount').textContent = filled;
            const total = currentSteps.length;
            const pct = total > 0 ? (filled / total) * 100 : 0;
            document.getElementById('progressFill').style.width = pct + '%';

            const userName = (document.getElementById('userNameInput').value || '').trim();
            document.getElementById('submitBtn').disabled = (filled < total || total === 0 || !userName);
        }

        // ‚îÄ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ‚îÄ
        async function submitDescriptions() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            const userName = (document.getElementById('userNameInput').value || '').trim();
            if (!userName) {
                showToast('Please enter your name first', 'error');
                btn.textContent = 'Submit';
                updateProgress();
                return;
            }

            const result = {
                venue: 'zorlu',
                submitted_by: userName,
                start_room: currentRoute.start,
                end_room: currentRoute.end,
                floor: currentRoute.floor,
                start_floor: currentRoute.start_floor,
                end_floor: currentRoute.end_floor,
                timestamp: new Date().toISOString(),
                steps: currentSteps.map(step => ({
                    step_number: step.step_number,
                    action: step.action,
                    distance_meters: step.distance_meters,
                    landmark: step.landmark,
                    system_description: step.description,
                    human_description: (userDescriptions[step.step_number] || '').trim()
                }))
            };

            try {
                const resp = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(result)
                });

                const data = await resp.json();

                if (resp.ok) {
                    showToast('Submitted successfully', 'success');
                    submittedRoutes.add(getRouteId());
                    updateDuplicateChip();
                    userDescriptions = {};
                    renderSteps();
                    updateProgress();
                } else {
                    showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (err) {
                showToast('Connection error: ' + err.message, 'error');
            } finally {
                btn.textContent = 'Submit';
                updateProgress();
            }
        }

        // ‚îÄ‚îÄ‚îÄ DUPLICATE CHECK ‚îÄ‚îÄ‚îÄ
        function getRouteId() {
            const s = currentRoute.start.replace(/ - /g, '_').replace(/ /g, '_');
            const e = currentRoute.end.replace(/ - /g, '_').replace(/ /g, '_');
            return `${currentRoute.start_floor}_${s}_to_${currentRoute.end_floor}_${e}`;
        }

        function updateDuplicateChip() {
            const chip = document.getElementById('duplicateChip');
            if (!currentRoute.start || !currentRoute.end) {
                chip.innerHTML = '';
                return;
            }
            const routeId = getRouteId();
            if (submittedRoutes.has(routeId)) {
                chip.innerHTML = '<span class="duplicate-chip exists">Already submitted</span>';
            } else {
                chip.innerHTML = '<span class="duplicate-chip new-route">New route</span>';
            }
        }

        // ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ
        function showToast(msg, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show' + (type ? ' ' + type : '');
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        // ‚îÄ‚îÄ‚îÄ TAB SWITCHING (mobile) ‚îÄ‚îÄ‚îÄ
        function switchTab(tab) {
            const mapPanel = document.getElementById('mapPanel');
            const stepsPanel = document.getElementById('stepsPanel');
            const tabMap = document.getElementById('tabMap');
            const tabSteps = document.getElementById('tabSteps');

            if (tab === 'map') {
                mapPanel.classList.add('active-tab');
                mapPanel.classList.remove('hidden-tab');
                stepsPanel.classList.add('hidden-tab');
                stepsPanel.classList.remove('active-tab');
                tabMap.classList.add('active');
                tabSteps.classList.remove('active');
                // Re-trigger panzoom resize
                if (pzInstance) {
                    setTimeout(() => pzInstance.resume(), 50);
                }
            } else {
                stepsPanel.classList.add('active-tab');
                stepsPanel.classList.remove('hidden-tab');
                mapPanel.classList.add('hidden-tab');
                mapPanel.classList.remove('active-tab');
                tabSteps.classList.add('active');
                tabMap.classList.remove('active');
            }
        }

        // Auto-switch to steps tab when route is calculated (mobile)
        function autoSwitchToStepsIfMobile() {
            if (window.innerWidth <= 768 && currentSteps.length > 0) {
                switchTab('steps');
            }
        }

        // ‚îÄ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            if (e.key === 'Enter') calculateRoute();
        });

        // ‚îÄ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ
        init();
    </script>
</body>
</html>

