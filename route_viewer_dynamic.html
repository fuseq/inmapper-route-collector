<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Description Collector</title>
    <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
        .header {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 16px;
            z-index: 100;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .floor-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .room-selector-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .room-selector-group label {
            font-size: 12px;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
        }

        .room-select {
            padding: 5px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            background: white;
            cursor: pointer;
            min-width: 140px;
            transition: border-color 0.2s;
        }

        .room-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .room-select.start { border-color: #28a745; }
        .room-select.end { border-color: #dc3545; }

        .calc-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .calc-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
        .calc-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .route-info {
            font-size: 12px;
            color: #888;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .route-info strong { color: #667eea; }

        /* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            gap: 12px;
            padding: 12px;
        }

        /* ‚îÄ‚îÄ‚îÄ MAP PANEL ‚îÄ‚îÄ‚îÄ */
        .map-panel {
            flex: 1 1 58%;
            position: relative;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            overflow: hidden;
            min-width: 0;
        }

        .svg-container {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        .svg-container:active { cursor: grabbing; }

        .svg-container svg {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(8px);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            color: #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
            pointer-events: none;
        }

        .map-overlay strong { color: #667eea; }

        .zoom-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 10;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            background: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .zoom-btn:hover { background: #667eea; color: white; }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }

        .loading-overlay.active { display: flex; }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ‚îÄ STEPS PANEL ‚îÄ‚îÄ‚îÄ */
        .steps-panel {
            flex: 0 0 40%;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            overflow: hidden;
        }

        .steps-header {
            padding: 14px 18px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }

        .steps-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
        }

        .steps-subtitle {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }

        .progress-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .steps-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px 16px;
            scrollbar-gutter: stable;
        }

        .steps-list::-webkit-scrollbar { width: 6px; }
        .steps-list::-webkit-scrollbar-track { background: transparent; }
        .steps-list::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }

        .step-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .step-card.filled { border-color: #28a745; background: #f8fff9; }

        .step-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
            background: #667eea;
        }

        .step-number.start { background: #667eea; }
        .step-number.turn, .step-number.turn_left, .step-number.turn_right { background: #e74c3c; }
        .step-number.veer { background: #f39c12; }
        .step-number.pass_by { background: #3498db; }
        .step-number.arrive { background: #27ae60; }
        .step-number.floor_change { background: #9b59b6; }

        .step-action {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
        }

        .step-action.start { background: #667eea; }
        .step-action.turn, .step-action.turn_left, .step-action.turn_right { background: #e74c3c; }
        .step-action.veer { background: #f39c12; }
        .step-action.pass_by { background: #3498db; }
        .step-action.arrive { background: #27ae60; }
        .step-action.floor_change { background: #9b59b6; }

        .step-landmark {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        .step-distance {
            font-size: 12px;
            color: #888;
            margin-left: auto;
        }

        .step-system-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #999;
            margin-bottom: 2px;
        }

        .step-system-desc {
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 12px;
            color: #555;
            background: #f8f9fa;
            padding: 8px 10px;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .step-input-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #667eea;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .step-textarea {
            width: 100%;
            min-height: 60px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .step-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .step-textarea.has-text { border-color: #28a745; }
        .step-textarea::placeholder { color: #bbb; font-size: 13px; }

        /* ‚îÄ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ */
        .steps-footer {
            padding: 14px 20px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            gap: 10px;
        }

        .steps-counter { font-size: 13px; color: #888; font-weight: 500; }
        .steps-counter strong { color: #667eea; }

        .submit-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #aaa;
            font-size: 14px;
            text-align: center;
            padding: 40px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        /* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            transition: transform 0.3s ease;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- HEADER -->
        <div class="header">
            <div class="title">
                Route Description Collector
            </div>

            <div class="room-selector-group">
                <label>Kat:</label>
                <select class="room-select" id="floorSelect" onchange="onFloorChange()"></select>
            </div>

            <div class="room-selector-group">
                <label>Ba≈ülangƒ±√ß:</label>
                <select class="room-select start" id="startSelect"></select>
            </div>

            <div class="room-selector-group">
                <label>Hedef:</label>
                <select class="room-select end" id="endSelect"></select>
            </div>

            <button class="calc-btn" id="calcBtn" onclick="calculateRoute()">
                Hesapla
            </button>

            <div class="route-info" id="routeInfo" style="display: none;">
                <span>Mesafe: <strong id="distInfo">-</strong></span>
                <span>D√∂n√º≈ü: <strong id="turnInfo">-</strong></span>
            </div>
        </div>

        <!-- MAIN -->
        <div class="main-content">
            <!-- MAP -->
            <div class="map-panel">
                <div class="map-overlay" id="mapOverlay">
                    Zoom: <strong id="zoomLevel">100%</strong>
                </div>

                <div class="svg-container" id="svgContainer"></div>

                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="pzZoomIn()">+</button>
                    <button class="zoom-btn" onclick="pzZoomOut()">‚àí</button>
                    <button class="zoom-btn" onclick="pzReset()" title="Reset">‚ü≤</button>
                </div>

                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                    Rota hesaplanƒ±yor...
                </div>
            </div>

            <!-- STEPS -->
            <div class="steps-panel">
                <div class="steps-header">
                    <div class="steps-title">Step Descriptions</div>
                    <div class="steps-subtitle">Write your own description for each step</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="steps-list" id="stepsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        Rota hesaplandƒ±ƒüƒ±nda<br>adƒ±mlar burada g√∂r√ºnecek
                    </div>
                </div>

                <div class="steps-footer">
                    <div class="steps-counter">
                        <strong id="filledCount">0</strong> / <span id="totalCount">0</span> completed
                    </div>
                    <button class="submit-btn" id="submitBtn" disabled onclick="submitDescriptions()">
                        Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
        let allRooms = {};
        let currentSteps = [];
        let userDescriptions = {};
        let pzInstance = null;
        let currentRoute = { start: '', end: '', floor: '' };

        // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
        async function init() {
            try {
                const resp = await fetch('/api/rooms');
                allRooms = await resp.json();
                populateFloorSelect();
                onFloorChange();
            } catch (e) {
                console.error('Rooms y√ºklenemedi:', e);
            }
        }

        function populateFloorSelect() {
            const sel = document.getElementById('floorSelect');
            sel.innerHTML = '';
            for (const floor of Object.keys(allRooms)) {
                const opt = document.createElement('option');
                opt.value = floor;
                opt.textContent = floor;
                sel.appendChild(opt);
            }
        }

        async function onFloorChange() {
            const floor = document.getElementById('floorSelect').value;
            const rooms = allRooms[floor] || [];
            populateRoomSelect('startSelect', rooms);
            populateRoomSelect('endSelect', rooms);

            // Se√ßili katƒ±n SVG'sini y√ºkle
            await loadFloorSvg(floor);
        }

        async function loadFloorSvg(floorName) {
            const container = document.getElementById('svgContainer');
            try {
                const resp = await fetch(`/api/floor-svg/${encodeURIComponent(floorName)}`);
                if (!resp.ok) throw new Error('SVG y√ºklenemedi');
                const svgContent = await resp.text();
                updateMap(svgContent);
            } catch (e) {
                console.error('Floor SVG y√ºklenemedi:', e);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üó∫Ô∏è</div>Harita y√ºklenemedi</div>';
            }
        }

        function populateRoomSelect(selectId, rooms) {
            const sel = document.getElementById(selectId);
            sel.innerHTML = '<option value="">-- Se√ßin --</option>';
            for (const room of rooms) {
                const opt = document.createElement('option');
                opt.value = room.id;
                opt.textContent = room.label;
                sel.appendChild(opt);
            }
        }

        // ‚îÄ‚îÄ‚îÄ ROUTE CALCULATION ‚îÄ‚îÄ‚îÄ
        async function calculateRoute() {
            const floor = document.getElementById('floorSelect').value;
            const startId = document.getElementById('startSelect').value;
            const endId = document.getElementById('endSelect').value;

            if (!startId || !endId) {
                showToast('Ba≈ülangƒ±√ß ve hedef se√ßin', 'error');
                return;
            }

            if (startId === endId) {
                showToast('Ba≈ülangƒ±√ß ve hedef farklƒ± olmalƒ±', 'error');
                return;
            }

            // Loading
            const btn = document.getElementById('calcBtn');
            btn.disabled = true;
            btn.textContent = '...';
            document.getElementById('loadingOverlay').classList.add('active');

            try {
                const resp = await fetch('/api/route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_floor: floor,
                        start_id: startId,
                        end_floor: floor,
                        end_id: endId
                    })
                });

                const data = await resp.json();

                if (!resp.ok) {
                    showToast(data.error || 'Rota hesaplanamadƒ±', 'error');
                    return;
                }

                // Update map
                updateMap(data.svg);

                // Update steps
                currentSteps = data.steps;
                currentRoute = { start: data.start, end: data.end, floor: data.floor };
                userDescriptions = {};
                renderSteps();

                // Update info
                document.getElementById('routeInfo').style.display = 'flex';
                document.getElementById('distInfo').textContent = data.distance.toFixed(1) + 'm';
                document.getElementById('turnInfo').textContent = data.turns;

                showToast('Rota hesaplandƒ± ‚úì', 'success');

            } catch (e) {
                console.error(e);
                showToast('Sunucu hatasƒ±', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Hesapla';
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        // ‚îÄ‚îÄ‚îÄ MAP ‚îÄ‚îÄ‚îÄ
        function updateMap(svgContent) {
            const container = document.getElementById('svgContainer');

            // Destroy old panzoom
            if (pzInstance) {
                pzInstance.dispose();
                pzInstance = null;
            }

            // Set SVG content
            container.innerHTML = svgContent;

            // Find the SVG element
            const svgEl = container.querySelector('svg');
            if (!svgEl) return;

            // Init panzoom on the SVG element
            pzInstance = panzoom(svgEl, {
                maxZoom: 10,
                minZoom: 0.1,
                smoothScroll: false,
                zoomDoubleClickSpeed: 1,
                beforeWheel: function(e) {
                    return false; // allow wheel zoom always
                },
                beforeMouseDown: function(e) {
                    return false; // allow pan always
                }
            });

            // Update zoom level display
            pzInstance.on('zoom', function(e) {
                const t = e.getTransform();
                document.getElementById('zoomLevel').textContent = Math.round(t.scale * 100) + '%';
            });
        }

        function pzZoomIn() {
            if (pzInstance) {
                const t = pzInstance.getTransform();
                const container = document.getElementById('svgContainer');
                const rect = container.getBoundingClientRect();
                pzInstance.smoothZoom(rect.width / 2, rect.height / 2, 1.3);
            }
        }

        function pzZoomOut() {
            if (pzInstance) {
                const t = pzInstance.getTransform();
                const container = document.getElementById('svgContainer');
                const rect = container.getBoundingClientRect();
                pzInstance.smoothZoom(rect.width / 2, rect.height / 2, 0.7);
            }
        }

        function pzReset() {
            if (pzInstance) {
                pzInstance.moveTo(0, 0);
                pzInstance.zoomAbs(0, 0, 1);
                document.getElementById('zoomLevel').textContent = '100%';
            }
        }

        // ‚îÄ‚îÄ‚îÄ STEPS RENDERING ‚îÄ‚îÄ‚îÄ
        function getActionClass(action) {
            const a = action.toLowerCase();
            if (a === 'start') return 'start';
            if (a.includes('turn')) return a.replace(' ', '_');
            if (a === 'veer') return 'veer';
            if (a === 'pass_by') return 'pass_by';
            if (a === 'arrive') return 'arrive';
            if (a === 'floor_change') return 'floor_change';
            return 'start';
        }

        function getActionLabel(action) {
            const labels = {
                'START': 'START',
                'TURN_LEFT': 'TURN LEFT',
                'TURN_RIGHT': 'TURN RIGHT',
                'VEER': 'VEER',
                'PASS_BY': 'PASS BY',
                'ARRIVE': 'ARRIVE',
                'FLOOR_CHANGE': 'FLOOR'
            };
            return labels[action] || action;
        }

        function renderSteps() {
            const stepsEl = document.getElementById('stepsList');

            if (currentSteps.length === 0) {
                stepsEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div>Rota hesaplandƒ±ƒüƒ±nda<br>adƒ±mlar burada g√∂r√ºnecek</div>';
                return;
            }

            let html = '';
            currentSteps.forEach((step) => {
                const actionClass = getActionClass(step.action);
                const savedText = userDescriptions[step.step_number] || '';
                const filledClass = savedText.trim() ? ' filled' : '';
                const textClass = savedText.trim() ? ' has-text' : '';

                const distVal = step.distance_meters != null ? step.distance_meters : 0;
                const distStr = distVal.toFixed(1) + 'm';
                const landmark = step.landmark || '';
                const landmarkBracket = landmark ? `[${landmark}]` : '';

                const actionPad = step.action.padEnd(12);
                const distPad = distStr.padStart(5);
                const landmarkPad = landmarkBracket.padEnd(20);
                const fullSystemLine = `${step.step_number}. ${actionPad} ${distPad} ${landmarkPad} | ${step.description}`;

                html += `
                <div class="step-card${filledClass}" id="card-${step.step_number}">
                    <div class="step-card-header">
                        <div class="step-number ${actionClass}">${step.step_number}</div>
                        <span class="step-action ${actionClass}">${getActionLabel(step.action)}</span>
                        ${landmark ? `<span class="step-landmark">${landmark}</span>` : ''}
                        ${distStr !== '0.0m' ? `<span class="step-distance">${distStr}</span>` : ''}
                    </div>
                    <div class="step-system-label">System</div>
                    <div class="step-system-desc">${fullSystemLine}</div>
                    <div class="step-input-label">Your Description</div>
                    <textarea 
                        class="step-textarea${textClass}" 
                        id="input-${step.step_number}" 
                        data-step="${step.step_number}"
                        placeholder="Bu adƒ±m i√ßin tarifinizi yazƒ±n..."
                        oninput="onStepInput(this)"
                    >${savedText}</textarea>
                </div>`;
            });

            stepsEl.innerHTML = html;
            document.getElementById('totalCount').textContent = currentSteps.length;
            updateProgress();
        }

        function onStepInput(el) {
            const stepNum = parseInt(el.dataset.step);
            const text = el.value.trim();
            userDescriptions[stepNum] = el.value;

            const card = document.getElementById('card-' + stepNum);
            if (text) {
                el.classList.add('has-text');
                card.classList.add('filled');
            } else {
                el.classList.remove('has-text');
                card.classList.remove('filled');
            }
            updateProgress();
        }

        function updateProgress() {
            let filled = 0;
            currentSteps.forEach(step => {
                if ((userDescriptions[step.step_number] || '').trim()) filled++;
            });

            document.getElementById('filledCount').textContent = filled;
            const total = currentSteps.length;
            const pct = total > 0 ? (filled / total) * 100 : 0;
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('submitBtn').disabled = (filled < total || total === 0);
        }

        // ‚îÄ‚îÄ‚îÄ SUBMIT ‚îÄ‚îÄ‚îÄ
        function submitDescriptions() {
            const result = {
                venue: 'zorlu',
                start_room: currentRoute.start,
                end_room: currentRoute.end,
                floor: currentRoute.floor,
                timestamp: new Date().toISOString(),
                routes: {}
            };

            result.routes['shortest'] = currentSteps.map(step => ({
                step_number: step.step_number,
                action: step.action,
                distance_meters: step.distance_meters,
                landmark: step.landmark,
                system_description: step.description,
                human_description: (userDescriptions[step.step_number] || '').trim()
            }));

            const blob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '_');
            a.download = `tarif_${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('JSON dosyasƒ± indirildi ‚úì', 'success');
        }

        // ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ
        function showToast(msg, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show' + (type ? ' ' + type : '');
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        // ‚îÄ‚îÄ‚îÄ KEYBOARD ‚îÄ‚îÄ‚îÄ
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            if (e.key === 'Enter') calculateRoute();
        });

        // ‚îÄ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ
        init();
    </script>
</body>
</html>

